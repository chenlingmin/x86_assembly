     1                                           ;代码清单15-2
     2                                           ;文件名：c15.asm
     3                                           ;文件说明：用户程序
     4                                           ;创建日期：2011-11-15 19:11
     5                                  
     6                                  ;===============================================================================
     7                                  SECTION header vstart=0
     8                                  
     9 00000000 [00000000]                       program_length   dd program_end          ;程序总长度#0x00
    10                                  
    11 00000004 [28030000]                       head_len         dd header_end           ;程序头部的长度#0x04
    12                                  
    13 00000008 00000000                         stack_seg        dd 0                    ;用于接收堆栈段选择子#0x08
    14 0000000C 01000000                         stack_len        dd 1                    ;程序建议的堆栈大小#0x0c
    15                                                                                    ;以4KB为单位
    16                                  
    17 00000010 [00000000]                       prgentry         dd start                ;程序入口#0x10
    18 00000014 [00000000]                       code_seg         dd section.code.start   ;代码段位置#0x14
    19 00000018 [36000000]                       code_len         dd code_end             ;代码段长度#0x18
    20                                  
    21 0000001C [00000000]                       data_seg         dd section.data.start   ;数据段位置#0x1c
    22 00000020 [4C000000]                       data_len         dd data_end             ;数据段长度#0x20
    23                                  ;-------------------------------------------------------------------------------
    24                                           ;符号地址检索表
    25 00000024 03000000                         salt_items       dd (header_end-salt)/256 ;#0x24
    26                                  
    27                                           salt:                                     ;#0x28
    28 00000028 405072696E74537472-              PrintString      db  '@PrintString'
    28 00000031 696E67             
    29 00000034 00<rep F4h>                                  times 256-($-PrintString) db 0
    30                                  
    31 00000128 405465726D696E6174-              TerminateProgram db  '@TerminateProgram'
    31 00000131 6550726F6772616D   
    32 00000139 00<rep EFh>                                  times 256-($-TerminateProgram) db 0
    33                                  
    34 00000228 40526561644469736B-              ReadDiskData     db  '@ReadDiskData'
    34 00000231 44617461           
    35 00000235 00<rep F3h>                                  times 256-($-ReadDiskData) db 0
    36                                  
    37                                  header_end:
    38                                  
    39                                  ;===============================================================================
    40                                  SECTION data vstart=0
    41                                  
    42 00000000 0D0A                             message_1        db  0x0d,0x0a
    43 00000002 5B5553455220544153-                               db  '[USER TASK]: Hi! nice to meet you,'
    43 0000000B 4B5D3A20486921206E-
    43 00000014 69636520746F206D65-
    43 0000001D 657420796F752C     
    44 00000024 4920616D2072756E20-                               db  'I am run at CPL=',0
    44 0000002D 61742043504C3D00   
    45                                  
    46 00000035 00                               message_2        db  0
    47 00000036 2E4E6F772C49206D75-                               db  '.Now,I must exit...',0x0d,0x0a,0
    47 0000003F 737420657869742E2E-
    47 00000048 2E0D0A00           
    48                                  
    49                                  data_end:
    50                                  
    51                                  ;===============================================================================
    52                                        [bits 32]
    53                                  ;===============================================================================
    54                                  SECTION code vstart=0
    55                                  start:
    56                                           ;任务启动时，DS指向头部段，也不需要设置堆栈
    57 00000000 8CD8                             mov eax,ds
    58 00000002 8EE0                             mov fs,eax
    59                                  
    60 00000004 A1[1C000000]                     mov eax,[data_seg]
    61 00000009 8ED8                             mov ds,eax
    62                                  
    63 0000000B BB[00000000]                     mov ebx,message_1
    64 00000010 64FF1D[28000000]                 call far [fs:PrintString]
    65                                  
    66 00000017 668CC8                           mov ax,cs
    67 0000001A 2403                             and al,0000_0011B
    68 0000001C 0C30                             or al,0x0030
    69 0000001E A2[35000000]                     mov [message_2],al
    70                                  
    71 00000023 BB[35000000]                     mov ebx,message_2
    72 00000028 64FF1D[28000000]                 call far [fs:PrintString]
    73                                  
    74 0000002F 64FF1D[28010000]                 call far [fs:TerminateProgram]      ;退出，并将控制权返回到核心
    75                                  
    76                                  code_end:
    77                                  
    78                                  ;-------------------------------------------------------------------------------
    79                                  SECTION trail
    80                                  ;-------------------------------------------------------------------------------
    81                                  program_end:
